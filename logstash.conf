input {
  beats {
    port => 5044
  }
}

filter {
  grok {
    match => {"message"=>[
      "%{WORD:level} %{TIMESTAMP_ISO8601:date} \[%{WORD:thread}\] %{JAVACLASS:class} - %{WORD:type}\|%{NUMBER:status:int}\|%{USERNAME:user}\|%{IP:ip}",
      "%{WORD:level} %{TIMESTAMP_ISO8601:date} \[%{WORD:thread}\] %{JAVACLASS:class} - %{WORD:type}\|%{NUMBER:duration:float}\|%{DATA:action}\|%{WORD:status}\|%{USERNAME:user}",
      "(?m)%{WORD:level} %{TIMESTAMP_ISO8601:date} \[%{WORD:thread}\] %{JAVACLASS:class} - %{DATA:description}\|%{GREEDYDATA:stacktrace}"
      ]
    }
  }

  mutate {
    rename => {"@timestamp" => "processTime"}
  }

  if ![type] {
    mutate {
      add_field => {"type" => "JAVA_ERROR"}
    }
  }

  if [type]== "LOGIN" {
    
    mutate {
      add_field => {"login" => true}
    }

    if [status] > 300 {
      mutate {
        replace => {"login" => false}
      }
    }
    
    translate {
      field => "status"
      destination => "statusText"
      dictionary => {
        "200"=>"Login correcto"
        "201"=>"Login correcto tras varios intentos"
        "202"=>"Login con actualizaci칩n de password"
        "204"=>"Login autom치tico"
        "250"=>"Login recordado"
        "100"=>"Usuario suplantado"
        "150"=>"Usuario suplantado autom치ticamente"
        "400"=>"Usuario bloqueado"
        "404"=>"Usuario no encontrado"
        "500"=>"Contrase침a expirada"
      }
    }
  }


  date{
    match => ["date", "YYYY-MM-dd HH:mm:ss"]
    target => "@timestamp"
  }

  geoip {
    source => "ip"
  }

  ruby {
    code => "event.set('indexDay', event.get('[@timestamp]').time.localtime('+09:00').strftime('%Y%m%d'))"
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    template => "/usr/share/logstash/templates/logstash.template.json"
    template_name => "logstash"
    template_overwrite => true
    index => "logstash-%{indexDay}"
    codec => json
  }
  stdout {
    codec => json_lines
    #codec => rubydebug
  }
}
